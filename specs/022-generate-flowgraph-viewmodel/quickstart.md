# Quickstart: Generate FlowGraph ViewModel

**Feature**: 022-generate-flowgraph-viewmodel
**Date**: 2026-02-19

## Overview

This feature moves the hand-written ViewModel layer from KMPMobileApp into the StopWatch module, then extends ModuleGenerator to auto-generate ControllerInterface, ControllerAdapter, and ViewModel classes from a FlowGraph definition. Observable state is derived from **sink node input ports**: each sink input port becomes a StateFlow property using the port name and port data type.

## Before & After

### Module Dependency

**Before**: ViewModel classes in KMPMobileApp, tightly coupled to StopWatch
```text
KMPMobileApp
├── viewmodel/
│   ├── StopWatchViewModel.kt           ← here
│   ├── StopWatchControllerInterface.kt ← here
│   └── StopWatchControllerAdapter.kt   ← here
└── depends on → StopWatch (for Controller)
```

**After**: ViewModel classes in StopWatch module, self-contained
```text
StopWatch
├── generated/
│   ├── StopWatchController.kt           (existing, updated)
│   ├── StopWatchFlow.kt                 (existing)
│   ├── StopWatchControllerInterface.kt  ← moved here (then generated)
│   ├── StopWatchControllerAdapter.kt    ← moved here (then generated)
│   └── StopWatchViewModel.kt            ← moved here (then generated)
└── usecases/
    ├── TimerEmitterComponent.kt
    └── DisplayReceiverComponent.kt      (StateFlows renamed)

KMPMobileApp
└── depends on → StopWatch (gets everything)
```

### Port Data Types Update

**Before**: Ports use `Any::class` (generic)
```kotlin
Port(name = "seconds", dataType = Any::class, ...)
Port(name = "minutes", dataType = Any::class, ...)
```

**After**: Ports use concrete types
```kotlin
Port(name = "seconds", dataType = Int::class, ...)
Port(name = "minutes", dataType = Int::class, ...)
```

### Component StateFlow Rename

**Before** (DisplayReceiverComponent):
```kotlin
val displayedSecondsFlow: StateFlow<Int> = _displayedSeconds.asStateFlow()
val displayedMinutesFlow: StateFlow<Int> = _displayedMinutes.asStateFlow()
```

**After** (matches port name convention `{portName}Flow`):
```kotlin
val secondsFlow: StateFlow<Int> = _seconds.asStateFlow()
val minutesFlow: StateFlow<Int> = _minutes.asStateFlow()
```

### Controller StateFlow Wiring

**Before** (references generator/TimerEmitter):
```kotlin
val elapsedSeconds: StateFlow<Int> = flow.timerEmitter.elapsedSecondsFlow
val elapsedMinutes: StateFlow<Int> = flow.timerEmitter.elapsedMinutesFlow
```

**After** (references sink/DisplayReceiver using port names):
```kotlin
val seconds: StateFlow<Int> = flow.displayReceiver.secondsFlow
val minutes: StateFlow<Int> = flow.displayReceiver.minutesFlow
```

### Generated ControllerInterface

**Before** (hand-written in KMPMobileApp):
```kotlin
package io.codenode.mobileapp.viewmodel

interface StopWatchControllerInterface {
    val elapsedSeconds: StateFlow<Int>
    val elapsedMinutes: StateFlow<Int>
    val executionState: StateFlow<ExecutionState>
    fun start(): FlowGraph
    fun stop(): FlowGraph
    fun reset(): FlowGraph
    fun pause(): FlowGraph
    fun resume(): FlowGraph
}
```

**After** (generated by ModuleGenerator, port-derived names):
```kotlin
package io.codenode.stopwatch.generated

interface StopWatchControllerInterface {
    val seconds: StateFlow<Int>
    val minutes: StateFlow<Int>
    val executionState: StateFlow<ExecutionState>
    fun start(): FlowGraph
    fun stop(): FlowGraph
    fun reset(): FlowGraph
    fun pause(): FlowGraph
    fun resume(): FlowGraph
}
```

### KMPMobileApp Import & Property Changes

**Before**:
```kotlin
import io.codenode.mobileapp.viewmodel.StopWatchControllerAdapter
import io.codenode.mobileapp.viewmodel.StopWatchViewModel

// In StopWatch.kt:
val seconds by viewModel.elapsedSeconds.collectAsState()
val minutes by viewModel.elapsedMinutes.collectAsState()
```

**After**:
```kotlin
import io.codenode.stopwatch.generated.StopWatchControllerAdapter
import io.codenode.stopwatch.generated.StopWatchViewModel

// In StopWatch.kt:
val seconds by viewModel.seconds.collectAsState()
val minutes by viewModel.minutes.collectAsState()
```

### Code Generation Usage

```kotlin
val generator = ModuleGenerator()
val flowGraph = createStopWatchFlowGraph()  // FlowGraph with typed sink ports
val packageName = "io.codenode.stopwatch.generated"

// Generate all ViewModel layer files
val interfaceCode = generator.generateControllerInterfaceClass(flowGraph, packageName)
val adapterCode = generator.generateControllerAdapterClass(flowGraph, packageName)
val viewModelCode = generator.generateViewModelClass(flowGraph, packageName)

// Or generate complete module (includes all files)
val module = generator.generateModule(flowGraph, "StopWatch", packageName)
module.writeTo(outputDir)
```

### Multi-Sink Node Example (Edge Case)

When a FlowGraph has multiple sink nodes with input ports, properties are prefixed with the sink node name:

```kotlin
// FlowGraph with two sink nodes:
// DisplayReceiver (SINK): input ports seconds (Int), minutes (Int)
// AlertReceiver (SINK): input port alertLevel (Int)

// Generated ControllerInterface:
interface MyFlowControllerInterface {
    val displayReceiverSeconds: StateFlow<Int>    // prefixed
    val displayReceiverMinutes: StateFlow<Int>    // prefixed
    val alertReceiverAlertLevel: StateFlow<Int>   // prefixed
    val executionState: StateFlow<ExecutionState> // always unprefixed
    // ... lifecycle methods
}
```

## Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `StopWatch/build.gradle.kts` | Modify | Add `lifecycle-viewmodel-compose:2.8.0` dependency |
| `StopWatch/.../generated/StopWatchControllerInterface.kt` | Move | From KMPMobileApp, update package + rename properties |
| `StopWatch/.../generated/StopWatchControllerAdapter.kt` | Move | From KMPMobileApp, update package + rename properties |
| `StopWatch/.../generated/StopWatchViewModel.kt` | Move | From KMPMobileApp, update package + rename properties |
| `StopWatch/.../viewmodel/StopWatchViewModelTest.kt` | Move | From KMPMobileApp, update package + rename assertions |
| `StopWatch/.../viewmodel/FakeStopWatchController.kt` | Move | From KMPMobileApp, update package + rename properties |
| `StopWatch/.../usecases/DisplayReceiverComponent.kt` | Modify | Rename `displayedSecondsFlow` → `secondsFlow`, etc. |
| `StopWatch/.../generated/StopWatchController.kt` | Modify | Wire to sink StateFlows, rename properties |
| `StopWatch/StopWatch.flow.kt` | Modify | Update port types to `Int::class` |
| `KMPMobileApp/.../viewmodel/` | Delete | 3 source + 2 test files removed |
| `KMPMobileApp/.../App.kt` | Modify | Update imports to `io.codenode.stopwatch.generated` |
| `KMPMobileApp/.../StopWatch.kt` | Modify | Update imports + property names (`seconds`/`minutes`) |
| `kotlinCompiler/.../ModuleGenerator.kt` | Modify | Add 3 new generate methods + collectSinkPortProperties helper |
| `kotlinCompiler/.../ViewModelGeneratorTest.kt` | Create | Tests for ControllerInterface/Adapter/ViewModel generation |
| `kotlinCompiler/.../RegenerateStopWatch.kt` | Modify | Update port types, generate 3 new files |
| `specs/.../undefined-inputs.md` | Create | US5 analysis document |
